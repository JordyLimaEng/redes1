<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>usuario</title>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <form id="usuario">
        <input type="hidden" id="hora" name="hora">
        <input type="hidden" id="date" name="date">
        <input type="hidden" id="IP"   name="IP">
        <input type="text" name="username" placeholder="Digite seu usuario">
        <div class="messages"></div>
        <input type="text" id="message" name="message" placeholder="Digite sua mensagem">
        <button type="submit">Enviar</button>
	</form>
	
	<script type="text/javascript">
		function id( el ){
			return document.getElementById( el );
        }
        
        function date(){
			hoje = new Date();
			id('date').value = hoje.getHours() + ':' + hoje.getMinutes() + ':' + hoje.getSeconds();
		}
		window.onload = date;
		hoje = new Date();
		id('date').value = hoje.getHours() + ':' + hoje.getMinutes() + ':' + hoje.getSeconds();        
        
        var a = id('IP').value = "127.0.0.1:3" + (Math.floor(Math.random() * (500 - 300 + 1) ) + 300); 
        console.log(a);
        
		hoje = new Date();
        id('hora').value = hoje.getHours() + ':' + hoje.getMinutes() + ':' + hoje.getSeconds();
        id('date').value = hoje.getDate() + '/' + hoje.getMonth() + '/' + hoje.getFullYear();

        var socket = io('http://localhost:3000'); 

        function renderMessage(message){
            $('.messages').append('<div class="message">'+'['+'<strong>'+message.hora+']'+ message.usuario +'</strong>:'+message.msg + '</div>');
        }

        socket.on('previousMessages', function(messages){
			for(message of messages){
                renderMessage(message);
            }
        });

        socket.on('receivedMessage', function(message){
            renderMessage(message);
        });

        $('#usuario').submit(function(event){
			hoje = new Date();
			id('hora').value = hoje.getHours() + ':' + hoje.getMinutes() + ':' + hoje.getSeconds();
            event.preventDefault();

            var author = $('input[name=username]').val();
			var message = $('input[name=message]').val();
            var hora = $('input[name=hora]').val();
            var date = $('input[name=date]').val();
            var   IP = $('input[name=IP]').val();
            

            if(author.length && message.length){
                var messageObject = {
                    usuario: author,
					IP:IP,
                    data:date,
                    hora: hora,
                    msg: message,
                };

				renderMessage(messageObject);
				id('message').value =''

                socket.emit('sendMessage', messageObject);
            }
        }); 
    </script>
</body>

</html>